{% extends 'Base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ManageOrders.css' %}">
{% endblock %}
{% block content %}
<section id="manage-order-section">
    <div class="container mt-5">
        <div class="order-status-container">
            {% with placed=0 shipped=0 completed=0 cancelled=0 %}
                {% for order in orders %}
                    {% if order.OrderStatus == "Placed" %}
                        {% with placed=placed|add:1 %}
                        {% endwith %}
                    {% elif order.OrderStatus == "Shipped" %}
                        {% with shipped=shipped|add:1 %}
                        {% endwith %}
                    {% elif order.OrderStatus == "Completed" %}
                        {% with completed=completed|add:1 %}
                        {% endwith %}
                    {% elif order.OrderStatus == "Cancelled" %}
                        {% with cancelled=cancelled|add:1 %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
                <div class="order-status-box">Order Placed: {{ placed }}</div>
                <div class="order-status-box">Order Shipped: {{ shipped }}</div>
                <div class="order-status-box">Order Completed: {{ completed }}</div>
                <div class="order-status-box">Order Cancelled: {{ cancelled }}</div>
            {% endwith %}
        </div>

        <section class="orders-section">
            <h2 class="text-center mb-4">ORDERS MANAGEMENT</h2>
            <div class="orders-header">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#placeOrderModal">
                    Place Order
                </button>
                <button class="sort-button">Sort by</button>
                <input type="text" id="search-bar" placeholder="Search by Order ID" class="search-bar">
            </div>
            <table class="table table-striped orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Supplier Name</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    {% for order in orders %}
                    <tr>
                        <td>{{ order.Order_ID }}</td>
                        <td>{{ order.Items.ItemName }}</td>
                        <td>{{ order.Quantity }}</td>
                        <td>{{ order.Supplier.SupplierName }}</td>
                        <td>{{ order.OrderStatus }}</td>
                        <td>
                            <button 
                                type="button" 
                                class="btn btn-primary change-status-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#changeStatusModal" 
                                data-order-id="{{ order.Order_ID }}" 
                                data-current-status="{{ order.OrderStatus }}">
                                Change Status
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>
</section>

<!-- Modal for Changing Status -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'ManageOrder' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="changeStatusModalLabel">Change Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="order_id" id="modal-order-id">
                    <p>Current Status: <strong id="modal-current-status"></strong></p>
                    <label for="new-status">Select New Status:</label>
                    <select name="new_status" id="new-status" class="form-select">
                        <option value="Placed">Placed</option>
                        <option value=" Shipped">Shipped</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Place Order -->
<div class="modal fade" id="placeOrderModal" tabindex="-1" aria-labelledby="placeOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="place-order-form" class="row g-3" action="{% url 'PlaceOrder' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="placeOrderModalLabel">Place Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Supplier Selection -->
                    <div class="col-12">
                        <label for="supplier-name" class="form-label">Supplier Name:</label>
                        <select id="supplier-name" name="supplier-name" class="form-select" required>
                            <option value="" disabled selected>Select Supplier</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.Supplier_ID }}">{{ supplier.SupplierName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Material Selection -->
                    <div class="col-12">
                        <label for="material" class="form-label">Material:</label>
                        <select id="material" name="material" class="form-select" required>
                            <option value="" disabled selected>Select Material</option>
                            {% for material in materials %}
                                <option value="{{ material.Inventory_ID }}" data-price="{{ material.PurchasePrice }}">{{ material.ItemName }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Quantity Input -->
                    <div class="col-12">
                        <label for="quantity" class="form-label">Quantity:</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" required>
                        <span id="unit-of-measure"></span>
                    </div>

                    <!-- Status and Price Info -->
                    <input type="hidden" id="status" name="status" value="Placed">
                    <div class="col-12">
                        <p>Base Price: <span id="base-price">0.00</span></p>
                        <p>Total Cost: <span id="total-cost">0.00</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Submit Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const supplierSelect = document.getElementById('supplier-name');
        const materialSelect = document.getElementById('material');
        const basePriceElement = document.getElementById('base-price');
        const totalCostElement = document.getElementById('total-cost');
        const quantityInput = document.getElementById('quantity');

        supplierSelect.addEventListener('change', function() {
            const supplierId = this.value;
            fetch(`/get_materials_by_supplier?supplier_id=${supplierId}`)
                .then(response => response.json())
                .then(data => {
                    materialSelect.innerHTML = '<option value="" disabled selected>Select Material</option>';
                    data.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material.Inventory_ID;
                        option.textContent = material.ItemName;
                        option.setAttribute('data-price', material.PurchasePrice); // Store price in data attribute
                        materialSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching materials:', error));
        });

        materialSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const purchasePrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
            basePriceElement.textContent = purchasePrice.toFixed(2); // Update base price display
            calculateTotalCost(purchasePrice);
        });

        quantityInput.addEventListener('input', function() {
            const purchasePrice = parseFloat(basePriceElement.textContent) || 0;
            calculateTotalCost(purchasePrice);
        });

        function calculateTotalCost(basePrice) {
            const quantity = parseInt(quantityInput.value) || 0;
            const totalCost = (basePrice * quantity).toFixed(2);
            totalCostElement.textContent = totalCost;
        }
    });
</script>
{% endblock %}