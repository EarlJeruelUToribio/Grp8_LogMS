{% extends 'Base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/PlaceOrder.css' %}">
{% endblock %}

{% block content %}
<div id="order-form" class="form-container container mt-5 d-flex justify-content-center">
    <div class="order-container col-md-6">
        <h2 class="text-center mb-4">PLACE ORDER</h2>
        <form method="POST" id="place-order-form" class="row g-3">
            {% csrf_token %}

            <div class="col-12">
                <label for="supplier-name" class="form-label">Supplier Name:</label>
                <select id="supplier-name" name="supplier-name" class="form-select" required>
                    <option value="" disabled selected>Select Supplier</option>
                    <!-- Supplier options will be populated based on selected material -->
                </select>
            </div>
            
            <div class="col-12">
                <label for="material" class="form-label">Material:</label>
                <select id="material" name="material" class="form-select" required>
                    <option value="" disabled selected>Select Material</option>
                    {% for material in materials %}
                    <option value="{{ material.Inventory_ID }}" data-price="{{ material.PurchasePrice }}" data-uom="{{ material.UnitOfMeasure }}">{{ material.ItemName }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12">
                <label for="quantity" class="form-label">Quantity:</label>
                <input type="number" class="form-control" id="quantity" name="quantity" required>
                <span id="unit-of-measure"></span>
            </div>

            <input type="hidden" id="status" name="status" value="Placed">
            <div class="col-12">
                <p>Base Price: <span id="base-price">0.00</span></p>
                <p>Total Cost: <span id="total-cost">0.00</span></p>
            </div>

            <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Submit Order</button>
            </div>
        </form>
    </div>
</div>


<script>
    document.getElementById('material').addEventListener('change', function() {
        const selectedMaterial = this.options[this.selectedIndex];
        const basePrice = parseFloat(selectedMaterial.getAttribute('data-price'));
        const selectedMaterialId = this.value;
        const supplierSelect = document.getElementById('supplier-name');

        // Update base price display
        document.getElementById('base-price').textContent = basePrice.toFixed(2);
        
        // Clear previous supplier options
        supplierSelect.innerHTML = '<option value="" disabled selected>Select Supplier</option>';
        
        // Populate suppliers based on selected material
        const suppliers = {{ material_suppliers|safe }};
        if (suppliers[selectedMaterialId]) {
            suppliers[selectedMaterialId].forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.Supplier_ID;
                option.textContent = supplier.SupplierName;
                supplierSelect.appendChild(option);
            });
        }

        // Reset quantity and total cost
        document.getElementById('quantity').value = '';
        document.getElementById('total-cost').textContent = '0.00';
    });

    document.getElementById('quantity').addEventListener('input', function() {
        const quantity = parseInt(this.value) || 0; // Default to 0 if not a number
        const selectedMaterial = document.getElementById('material').options[document.getElementById('material').selectedIndex];
        const basePrice = parseFloat(selectedMaterial.getAttribute('data-price'));
        const totalCost = basePrice * quantity;

        document.getElementById('total-cost').textContent = totalCost.toFixed(2);
    });
</script>
{% endblock %}